rules:
  # --- Eintritt: HONOS Pflicht, Eskalation nach 3 Tagen
  - id: HONOS_ENTRY_MISSING_WARN
    category: completeness
    severity: WARN
    metric: honos_entry_total
    operator: is_null
    value: true
    message: "HONOS Eintritt fehlt"
    explanation: "HONOS Eintritt ist noch nicht erfasst."

  - id: HONOS_ENTRY_MISSING_CRIT_3D
    category: completeness
    severity: CRITICAL
    metric: honos_entry_missing_over_3d
    operator: is_true
    value: true
    message: "HONOS Eintritt fehlt > 3 Tage"
    explanation: "HONOS Eintritt ist nach 3 Tagen immer noch nicht erfasst."

  # --- Eintritt: BSCL Pflicht, Eskalation nach 3 Tagen
  - id: BSCL_ENTRY_MISSING_WARN
    category: completeness
    severity: WARN
    metric: bscl_total_entry
    operator: is_null
    value: true
    message: "BSCL Eintritt fehlt"
    explanation: "BSCL Eintritt ist noch nicht erfasst."

  - id: BSCL_ENTRY_MISSING_CRIT_3D
    category: completeness
    severity: CRITICAL
    metric: bscl_entry_missing_over_3d
    operator: is_true
    value: true
    message: "BSCL Eintritt fehlt > 3 Tage"
    explanation: "BSCL Eintritt ist nach 3 Tagen immer noch nicht erfasst."

  # --- Austritt: HONOS Pflicht im +/- 3 Tage Fenster um Austritt
  - id: HONOS_DISCHARGE_MISSING_WARN
    category: completeness
    severity: WARN
    metric: honos_discharge_due_missing
    operator: is_true
    value: true
    message: "HONOS Austritt fehlt (im 3-Tage-Fenster)"
    explanation: "Bei Austritt muss HONOS Austritt im ±3 Tage Fenster dokumentiert werden."

  - id: HONOS_DISCHARGE_MISSING_CRIT_3D
    category: completeness
    severity: CRITICAL
    metric: honos_discharge_missing_over_3d_after_discharge
    operator: is_true
    value: true
    message: "HONOS Austritt fehlt > 3 Tage nach Austritt"
    explanation: "Austritts-HONOS ist 3 Tage nach Austritt immer noch nicht dokumentiert."

  # --- Austritt: BSCL Pflicht im +/- 3 Tage Fenster um Austritt
  - id: BSCL_DISCHARGE_MISSING_WARN
    category: completeness
    severity: WARN
    metric: bscl_discharge_due_missing
    operator: is_true
    value: true
    message: "BSCL Austritt fehlt (im 3-Tage-Fenster)"
    explanation: "Bei Austritt muss BSCL Austritt im ±3 Tage Fenster dokumentiert werden."

  - id: BSCL_DISCHARGE_MISSING_CRIT_3D
    category: completeness
    severity: CRITICAL
    metric: bscl_discharge_missing_over_3d_after_discharge
    operator: is_true
    value: true
    message: "BSCL Austritt fehlt > 3 Tage nach Austritt"
    explanation: "Austritts-BSCL ist 3 Tage nach Austritt immer noch nicht dokumentiert."

  # --- Differenz > 5 zwischen Eintritt und Austritt => WARN (Risk)
  - id: HONOS_DELTA_GT_5
    severity: WARN
    metric: honos_delta
    operator: ">"
    value: 5
    message: "HONOS Verschlechterung > 5"
    explanation: "Differenz zwischen Eintritt und Austritt > 5."

  - id: BSCL_DELTA_GT_5
    severity: WARN
    metric: bscl_delta
    operator: ">"
    value: 5
    message: "BSCL Verschlechterung > 5"
    explanation: "Differenz zwischen Eintritt und Austritt > 5."

  # --- Suizidalität Austritt >= 3 => CRITICAL (heikel)
  - id: SUICIDALITY_HIGH_AT_DISCHARGE
    severity: CRITICAL
    metric: suicidality_discharge_high
    operator: is_true
    value: true
    message: "Hohe Suizidalität bei Austritt"
    explanation: "Suizidalität bei Austritt (HONOS oder BSCL) ist >= 3. Bitte besonders prüfen (heikel)."

  # --- Isolation: offen > 48h => CRITICAL
  - id: ISOLATION_OPEN_GT_48H
    severity: CRITICAL
    metric: isolation_open_over_48h
    operator: is_true
    value: true
    message: "Isolation ohne Ende > 48h"
    explanation: "Isolation hat keinen Stop und läuft länger als 48 Stunden (möglicherweise Ende vergessen)."

  # --- Isolation mehrfach => WARN
  - id: ISOLATION_MULTIPLE
    severity: WARN
    metric: isolation_multiple
    operator: is_true
    value: true
    message: "Mehrfach-Isolation"
    explanation: "Mehr als eine Isolationsepisode im Fall."

  # --- BFS Paket: vollständig/ unvollständig (wie gehabt)
  - id: BFS_INCOMPLETE
    category: completeness
    severity: WARN
    metric: bfs_incomplete
    operator: is_true
    value: true
    message: "BFS Paket unvollständig"
    explanation: "BFS Daten 1–3 müssen vollständig sein; mindestens ein Feld fehlt."

  # ==========================================================================
  # NEUE REGELN – Täglich / Kosten & Qualität (completeness)
  # ==========================================================================

  # --- Behandlungsplan für nicht-freiwillige Patienten ---
  - id: TREATMENT_PLAN_MISSING_72H
    category: completeness
    severity: CRITICAL
    metric: treatment_plan_missing_involuntary_72h
    operator: is_true
    value: true
    message: "Behandlungsplan fehlt (nicht-freiwillig, >72h)"
    explanation: "Patient ist nicht freiwillig aufgenommen und hat nach >72h keinen dokumentierten Behandlungsplan."

  # --- SDEP bei Austritt ---
  - id: SDEP_INCOMPLETE_AT_DISCHARGE
    category: completeness
    severity: CRITICAL
    metric: sdep_incomplete_at_discharge
    operator: is_true
    value: true
    message: "SDEP nicht abgeschlossen (Austritt <72h)"
    explanation: "Austritt innerhalb der letzten 72h, SDEP-Erfassung ist noch nicht abgeschlossen."

  # ==========================================================================
  # NEUE REGELN – Täglich / Klinisch (medical)
  # ==========================================================================

  # --- EKG-Befundung ---
  - id: EKG_NOT_REPORTED_24H
    category: medical
    severity: CRITICAL
    metric: ekg_not_reported_24h
    operator: is_true
    value: true
    message: "EKG in den letzten 24h nicht befundet"
    explanation: "Ein EKG wurde in den letzten 24 Stunden durchgeführt, aber noch nicht befundet."

  # --- Clozapin: Neutrophile ---
  - id: CLOZAPIN_NEUTROPHILS_LOW
    category: medical
    severity: CRITICAL
    metric: clozapin_neutrophils_low
    operator: is_true
    value: true
    message: "Clozapin: Neutrophile <2 G/l"
    explanation: "Patient unter Clozapin mit Neutrophilenwert <2 G/l in den letzten 48h. Sofortige Überprüfung erforderlich."

  # --- Clozapin: Grosses Blutbild (<19 Wochen) ---
  - id: CLOZAPIN_CBC_MISSING_EARLY
    category: medical
    severity: WARN
    metric: clozapin_cbc_missing_early
    operator: is_true
    value: true
    message: "Clozapin <19 Wo: Grosses Blutbild fehlt (>7d)"
    explanation: "Patient unter Clozapin seit <19 Wochen. Grosses Blutbild in den letzten 7 Tagen fehlt."

  # --- Clozapin: Troponin (<5 Wochen) ---
  - id: CLOZAPIN_TROPONIN_MISSING_EARLY
    category: medical
    severity: WARN
    metric: clozapin_troponin_missing_early
    operator: is_true
    value: true
    message: "Clozapin <5 Wo: Troponin fehlt (>7d)"
    explanation: "Patient unter Clozapin seit <5 Wochen. Troponin in den letzten 7 Tagen fehlt."

  # ==========================================================================
  # NEUE REGELN – Wöchentlich / Klinisch (medical)
  # ==========================================================================

  # --- Eintritts-EKG ---
  - id: EKG_ENTRY_MISSING_7D
    category: medical
    severity: WARN
    metric: ekg_entry_missing_7d
    operator: is_true
    value: true
    message: "Eintritts-EKG fehlt (>7 Tage)"
    explanation: "Eintritt vor >7 Tagen, aber kein Eintritts-EKG dokumentiert."

  # --- Notfall-BEM > 3 Tage ---
  - id: EMERGENCY_BEM_OVER_3D
    category: medical
    severity: CRITICAL
    metric: emergency_bem_over_3d
    operator: is_true
    value: true
    message: "Notfall-BEM seit >3 Tagen"
    explanation: "Notfall-Behandlungs-/Ernährungs-/Medikationsplan (BEM) ist seit mehr als 3 Tagen aktiv."

  # --- Notfallmedikation > 3 Tage ---
  - id: EMERGENCY_MED_OVER_3D
    category: medical
    severity: CRITICAL
    metric: emergency_med_over_3d
    operator: is_true
    value: true
    message: "Notfallmedikation seit >3 Tagen"
    explanation: "Notfallmedikation läuft seit mehr als 3 Tagen. Reguläre Verordnung prüfen."

  # --- Allergien nicht erfasst nach 7 Tagen ---
  - id: ALLERGIES_MISSING_7D
    category: medical
    severity: WARN
    metric: allergies_missing_7d
    operator: is_true
    value: true
    message: "Allergien nicht erfasst (>7 Tage)"
    explanation: "Eintritt vor >7 Tagen, Allergien sind noch nicht dokumentiert."

  # ==========================================================================
  # Dokumentationsabschluss nach Austritt (completeness)
  # ==========================================================================

  - id: DOC_COMPLETION_WARN
    category: completeness
    severity: WARN
    metric: doc_completion_warn
    operator: is_true
    value: true
    message: "Dokumentation nach Austritt noch offen"
    explanation: "Der Fall wurde entlassen, die Dokumentation ist aber noch nicht abgeschlossen. Frist: 10 Tage nach Austritt."

  - id: DOC_COMPLETION_OVERDUE
    category: completeness
    severity: CRITICAL
    metric: doc_completion_overdue
    operator: is_true
    value: true
    message: "Dokumentation überfällig (≥10 Tage nach Austritt)"
    explanation: "Die 10-Tages-Frist für den Dokumentationsabschluss nach Austritt ist überschritten."

  # ==========================================================================
  # SpiGes / BFS Psychiatrie-Zusatzdaten (v4)
  # ==========================================================================

  # --- SpiGes Personendaten (MP 3.2) ---
  - id: SPIGES_ZIVILSTAND_MISSING
    category: completeness
    severity: WARN
    metric: zivilstand_missing
    operator: is_true
    value: true
    message: "SpiGes: Zivilstand fehlt"
    explanation: "Zivilstand (3.2.V01) ist nicht erfasst."

  - id: SPIGES_ZIVILSTAND_UNKNOWN
    category: completeness
    severity: WARN
    metric: zivilstand_unknown
    operator: is_true
    value: true
    message: "SpiGes: Zivilstand unbekannt"
    explanation: "Zivilstand (3.2.V01) ist als 'unbekannt' erfasst."

  - id: SPIGES_AUFENTHALTSORT_MISSING
    category: completeness
    severity: WARN
    metric: aufenthaltsort_missing
    operator: is_true
    value: true
    message: "SpiGes: Aufenthaltsort fehlt"
    explanation: "Aufenthaltsort vor Eintritt (3.2.V02) ist nicht erfasst."

  - id: SPIGES_BESCHAEFTIGUNG_MISSING
    category: completeness
    severity: WARN
    metric: beschaeftigung_missing
    operator: is_true
    value: true
    message: "SpiGes: Beschäftigung fehlt"
    explanation: "Keine Beschäftigung angegeben (mind. 1 von 7 Feldern muss 'ja' sein)."

  - id: SPIGES_SCHULBILDUNG_MISSING
    category: completeness
    severity: WARN
    metric: schulbildung_missing
    operator: is_true
    value: true
    message: "SpiGes: Schulbildung fehlt"
    explanation: "Schulbildung (3.2.V10) ist nicht erfasst."

  # --- SpiGes Eintrittsmerkmale (MP 3.3) ---
  - id: SPIGES_EINWEISENDE_INSTANZ_MISSING
    category: completeness
    severity: WARN
    metric: einweisende_instanz_missing
    operator: is_true
    value: true
    message: "SpiGes: Einweisende Instanz fehlt"
    explanation: "Einweisende Instanz (3.3.V01) ist nicht erfasst."

  - id: SPIGES_BEHANDLUNGSGRUND_MISSING
    category: completeness
    severity: WARN
    metric: behandlungsgrund_missing
    operator: is_true
    value: true
    message: "SpiGes: Behandlungsgrund fehlt"
    explanation: "Behandlungsgrund (3.3.V02) ist nicht erfasst."

  # --- SpiGes Austrittsmerkmale (MP 3.5, nur bei Austritt) ---
  - id: SPIGES_ENTSCHEID_AUSTRITT_MISSING
    category: completeness
    severity: WARN
    metric: entscheid_austritt_missing
    operator: is_true
    value: true
    message: "SpiGes: Entscheid Austritt fehlt"
    explanation: "Entscheid für Austritt (3.5.V01) ist nicht erfasst."

  - id: SPIGES_AUFENTHALT_NACH_AUSTRITT_MISSING
    category: completeness
    severity: WARN
    metric: aufenthalt_nach_austritt_missing
    operator: is_true
    value: true
    message: "SpiGes: Aufenthalt nach Austritt fehlt"
    explanation: "Aufenthalt nach Austritt (3.5.V02) ist nicht erfasst."

  - id: SPIGES_BEHANDLUNG_NACH_AUSTRITT_MISSING
    category: completeness
    severity: WARN
    metric: behandlung_nach_austritt_missing
    operator: is_true
    value: true
    message: "SpiGes: Behandlung nach Austritt fehlt"
    explanation: "Behandlung nach Austritt (3.5.V03) ist nicht erfasst."

  - id: SPIGES_BEHANDLUNGSBEREICH_MISSING
    category: completeness
    severity: WARN
    metric: behandlungsbereich_missing
    operator: is_true
    value: true
    message: "SpiGes: Behandlungsbereich fehlt"
    explanation: "Behandlungsbereich (3.5.V04) ist nicht erfasst."

  # ==========================================================================
  # FU – Fürsorgerische Unterbringung (v4)
  # ==========================================================================

  - id: FU_MISSING
    category: completeness
    severity: CRITICAL
    metric: fu_missing
    operator: is_true
    value: true
    message: "FU bei Eintritt nicht dokumentiert"
    explanation: "Patient ist nicht freiwillig aufgenommen, aber FU bei Eintritt (3.3.V03) ist nicht dokumentiert."

  - id: FU_EXPIRING_SOON
    category: medical
    severity: WARN
    metric: fu_expiring_soon
    operator: is_true
    value: true
    message: "FU läuft in ≤7 Tagen ab"
    explanation: "Die ärztliche FU läuft in weniger als 7 Tagen ab. Verlängerung oder KESB-Antrag prüfen."

  - id: FU_EXPIRED
    category: medical
    severity: CRITICAL
    metric: fu_expired
    operator: is_true
    value: true
    message: "FU abgelaufen!"
    explanation: "Die FU-Gültigkeitsdauer ist überschritten. Sofortige Klärung erforderlich (Art. 429 ZGB)."

  # ==========================================================================
  # Langlieger (v4)
  # ==========================================================================

  - id: LANGLIEGER_WARN
    category: medical
    severity: WARN
    metric: langlieger_warn
    operator: is_true
    value: true
    message: "Langlieger-Warnung (≥25 Tage)"
    explanation: "Patient ist seit ≥25 Tagen stationär. Überprüfung der Aufenthaltsdauer empfohlen."

  - id: LANGLIEGER_CRITICAL
    category: medical
    severity: CRITICAL
    metric: langlieger_critical
    operator: is_true
    value: true
    message: "Langlieger (≥28 Tage)"
    explanation: "Patient ist seit ≥28 Tagen (4 Wochen) stationär. Eskaliert alle 2 Wochen."

  # ==========================================================================
  # SpiGes Behandlungsdaten MP 3.4 (v5)
  # ==========================================================================

  - id: SPIGES_BEHANDLUNG_TYP_MISSING
    category: completeness
    severity: WARN
    metric: behandlung_typ_missing
    operator: is_true
    value: true
    message: "Behandlungstyp fehlt (MP 3.4.V02)"
    explanation: "BFS-Variable Behandlungstyp ist nicht ausgefüllt."

  - id: SPIGES_PSYCHOPHARMAKA_MISSING
    category: completeness
    severity: WARN
    metric: psychopharmaka_missing
    operator: is_true
    value: true
    message: "Psychopharmaka nicht dokumentiert (MP 3.4.V03-V13)"
    explanation: "Keines der 11 Psychopharmaka-Felder (V03-V13) ist ausgefüllt. Mindestens 1 Feld muss beantwortet sein."

  # ==========================================================================
  # MB Minimaldaten (v5)
  # ==========================================================================

  - id: MB_EINTRITTSART_MISSING
    category: completeness
    severity: WARN
    metric: eintrittsart_missing
    operator: is_true
    value: true
    message: "Eintrittsart fehlt (MB 1.2.V03)"
    explanation: "BFS-Minimaldaten-Variable Eintrittsart (Notfall/geplant/intern) ist nicht ausgefüllt."

  - id: MB_KLASSE_MISSING
    category: completeness
    severity: WARN
    metric: klasse_missing
    operator: is_true
    value: true
    message: "Klasse fehlt (MB 1.3.V02)"
    explanation: "BFS-Minimaldaten-Variable Klasse (allgemein/halbprivat/privat) ist nicht ausgefüllt."
